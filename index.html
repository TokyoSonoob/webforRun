import express from "express";

const app = express();
app.use(express.json());

let bots = {}; // { botId: timestamp }
let allowReceive = true;
let alerts = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á‡∏ö‡∏≠‡∏ó

// API ‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ó‡∏¢‡∏¥‡∏á‡∏°‡∏≤
app.post("/ping/:botId", (req, res) => {
  if (!allowReceive) return res.status(403).json({ message: "Receiving disabled" });
  const botId = req.params.botId;
  const now = Date.now();
  bots[botId] = now;
  alerts.unshift({ botId, time: now });
  if (alerts.length > 20) alerts.pop(); // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 20 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  res.json({ message: `Bot ${botId} ping received` });
});

// API ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î
app.post("/toggle", (req, res) => {
  allowReceive = !allowReceive;
  res.redirect("/");
});

// API ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏î‡∏∂‡∏á
app.get("/data", (req, res) => {
  res.json({ bots, alerts, allowReceive });
});

// ‡∏ï‡∏£‡∏ß‡∏à‡∏ö‡∏≠‡∏ó ‡πÅ‡∏•‡∏∞ deploy ‡∏ú‡πà‡∏≤‡∏ô Render
async function checkBots() {
  const now = Date.now();
  const timeout = 60000; // 1 ‡∏ô‡∏≤‡∏ó‡∏µ
  for (const [botId, lastPing] of Object.entries(bots)) {
    if (now - lastPing > timeout) {
      console.log(`‚ö† Bot ${botId} ‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏á‡∏°‡∏≤‡∏ô‡∏≤‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á deploy ‡∏ú‡πà‡∏≤‡∏ô Render...`);
      try {
        await fetch(`https://api.render.com/deploy/${botId}`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${process.env.RENDER_TOKEN}`,
            "Content-Type": "application/json"
          }
        });
      } catch (err) {
        console.error("Deploy error:", err);
      }
    }
  }
}
setInterval(checkBots, 30000);

// ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å
app.get("/", (req, res) => {
  res.send(`
  <html>
  <head>
    <meta charset="utf-8">
    <title>Bot Monitor Dashboard</title>
    <style>
      body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; padding: 20px; margin: 0; }
      h1 { text-align: center; color: #38bdf8; margin-bottom: 10px; }
      .section { margin-bottom: 30px; }
      .card { background: #1e293b; padding: 15px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 10px; border-bottom: 1px solid #334155; text-align: left; }
      th { background: #38bdf8; color: black; }
      tr:hover { background: #334155; }
      .status-on { color: #4ade80; font-weight: bold; }
      .status-off { color: #f87171; font-weight: bold; }
      .alert-list { list-style: none; padding: 0; margin: 0; }
      .alert-item { background: #1e3a8a; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
      .alert-bot { font-weight: bold; color: #93c5fd; }
      .alert-time { font-size: 0.9em; color: #e0f2fe; }
      .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
      .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: #4ade80; }
      input:checked + .slider:before { transform: translateX(26px); }
      form { text-align: center; margin-top: 10px; }
    </style>
  </head>
  <body>
    <h1>üì° Bot Monitor Dashboard</h1>

    <div class="section card">
      <h2>üîî ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
      <ul class="alert-list" id="alertList"></ul>
    </div>

    <div class="section card">
      <h2>üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ö‡∏≠‡∏ó</h2>
      <table>
        <thead><tr><th>Bot ID</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏¥‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr></thead>
        <tbody id="botTable"></tbody>
      </table>
    </div>

    <div class="section card">
      <h2>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>
      <form method="POST" action="/toggle">
        <label class="switch">
          <input type="checkbox" name="toggle" onchange="this.form.submit()" id="receiveSwitch">
          <span class="slider"></span>
        </label>
        <p id="receiveStatus"></p>
      </form>
    </div>

    <script>
      async function fetchData() {
        const res = await fetch('/data');
        const data = await res.json();

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏≠‡∏ó
        const botTable = document.getElementById('botTable');
        botTable.innerHTML = '';
        const now = Date.now();
        for (const [botId, lastPing] of Object.entries(data.bots)) {
          const diff = Math.floor((now - lastPing) / 1000);
          const status = diff > 60 ? '<span class="status-off">‚ùå ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö</span>' : '<span class="status-on">‚úÖ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>';
          botTable.innerHTML += \`<tr><td>\${botId}</td><td>\${new Date(lastPing).toLocaleTimeString()}</td><td>\${status}</td></tr>\`;
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        const alertList = document.getElementById('alertList');
        alertList.innerHTML = '';
        data.alerts.forEach(a => {
          alertList.innerHTML += \`<li class="alert-item"><span class="alert-bot">ü§ñ \${a.botId}</span><span class="alert-time">\${new Date(a.time).toLocaleTimeString()}</span></li>\`;
        });

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå
        document.getElementById('receiveSwitch').checked = data.allowReceive;
        document.getElementById('receiveStatus').textContent = data.allowReceive ? "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á" : "‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á";
      }

      setInterval(fetchData, 5000);
      fetchData();
    </script>
  </body>
  </html>
  `);
});

export default app;
