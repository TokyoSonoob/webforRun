import express from "express";

const app = express();
app.use(express.json());

let bots = {}; // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏¥‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î { botId: timestamp }
let allowReceive = true; // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏¢‡∏¥‡∏á

// API ‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ó‡∏¢‡∏¥‡∏á‡∏°‡∏≤
app.post("/ping/:botId", (req, res) => {
  if (!allowReceive) return res.status(403).json({ message: "Receiving disabled" });
  const botId = req.params.botId;
  bots[botId] = Date.now();
  res.json({ message: `Bot ${botId} ping received` });
});

// API ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î
app.post("/toggle", (req, res) => {
  allowReceive = !allowReceive;
  res.redirect("/");
});

// ‡∏ï‡∏£‡∏ß‡∏à‡∏ö‡∏≠‡∏ó ‡πÅ‡∏•‡∏∞ deploy ‡∏ú‡πà‡∏≤‡∏ô Render
async function checkBots() {
  const now = Date.now();
  const timeout = 60000; // 1 ‡∏ô‡∏≤‡∏ó‡∏µ
  for (const [botId, lastPing] of Object.entries(bots)) {
    if (now - lastPing > timeout) {
      console.log(`‚ö† Bot ${botId} ‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏á‡∏°‡∏≤‡∏ô‡∏≤‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á deploy ‡∏ú‡πà‡∏≤‡∏ô Render...`);
      try {
        await fetch(`https://api.render.com/deploy/${botId}`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${process.env.RENDER_TOKEN}`,
            "Content-Type": "application/json"
          }
        });
      } catch (err) {
        console.error("Deploy error:", err);
      }
    }
  }
}
setInterval(checkBots, 30000); // ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥

// ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å
app.get("/", (req, res) => {
  const now = Date.now();
  let html = `
  <html>
  <head>
    <meta charset="utf-8">
    <title>Bot Monitor</title>
    <style>
      body { font-family: 'Segoe UI', sans-serif; background: #1e1e2f; color: white; padding: 20px; }
      h1 { text-align: center; color: #00d4ff; }
      .status-on { color: #4CAF50; font-weight: bold; }
      .status-off { color: #FF5252; font-weight: bold; }
      table { border-collapse: collapse; width: 100%; background: #2c2c3e; border-radius: 10px; overflow: hidden; }
      th, td { padding: 12px 15px; border-bottom: 1px solid #444; }
      th { background: #00d4ff; color: black; }
      tr:hover { background: #383850; }
      .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
      .switch input { opacity: 0; width: 0; height: 0; }
      .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
      .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
      input:checked + .slider { background-color: #4CAF50; }
      input:checked + .slider:before { transform: translateX(26px); }
      form { text-align: center; margin-top: 20px; }
    </style>
  </head>
  <body>
    <h1>üì° Bot Monitor Dashboard</h1>
    <table>
      <tr><th>Bot ID</th><th>‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏¥‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr>
  `;

  for (const [botId, lastPing] of Object.entries(bots)) {
    const diff = Math.floor((now - lastPing) / 1000);
    html += `<tr>
      <td>${botId}</td>
      <td>${new Date(lastPing).toLocaleTimeString()}</td>
      <td class="${diff > 60 ? "status-off" : "status-on"}">${diff > 60 ? "‚ùå ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö" : "‚úÖ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå"}</td>
    </tr>`;
  }

  html += `
    </table>
    <form method="POST" action="/toggle">
      <label class="switch">
        <input type="checkbox" name="toggle" onchange="this.form.submit()" ${allowReceive ? "checked" : ""}>
        <span class="slider"></span>
      </label>
      <p>${allowReceive ? "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á" : "‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á"}</p>
    </form>
  </body>
  </html>
  `;

  res.send(html);
});

export default app;
